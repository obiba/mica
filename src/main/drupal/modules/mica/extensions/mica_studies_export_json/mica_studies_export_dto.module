<?php
/**
 * @file
 * Mica Studies Export module
 */

include_once('mica_studies_export_dto_contact.inc');
include_once('mica_studies_export_dto_study.inc');
include_once('mica_studies_export_dto_population.inc');
include_once('mica_studies_export_dto_dce.inc');
include_once('mica_studies_export_dto_dataset.inc');
include_once('mica_studies_export_dto_network.inc');

/**
 * Implements hook_menu().
 */
function mica_studies_export_dto_menu() {
  $items = array();
  $items['node/%node/export-dto'] = array(
    'title' => 'Export node to Mica-server',
    //  'access callback' => 'mica_export_can_export_node',
    'access arguments' => array(1),
    'page callback' => 'mica_studies_export_dto',
    'page arguments' => array(1),
  );
  return $items;
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function mica_studies_export_dto_menu_local_tasks_alter(&$data, $router_item, $root_path) {
  $links = array();
  if ($root_path === 'node/%') {
    $node = $router_item['map']['1'];
    if ($node->type === 'study' && mica_export_can_export_node($node)) {
      $links['export-study-xml'] = array(
        '#theme' => 'menu_local_action',
        '#weight' => 50,
        '#link' => array(
          'title' => t('Export'),
          'href' => 'node/' . $node->nid . '/export-xml'
        ),
      );
      $links['export-study-dto'] = array(
        '#theme' => 'menu_local_action',
        '#weight' => 50,
        '#link' => array(
          'title' => t('Export to mica-server'),
          'href' => 'node/' . $node->nid . '/export-dto'
        ),
      );

    }
  }
  $data['actions']['output'] = array_merge($data['actions']['output'], $links);
}

/**
 *
 */
function mica_studies_export_dto($node) {
  $operations = array();
  if ($node->type == 'study') {

    //get DTO

    $operations[] = array('_mica_studies_export_dto_study_dto', array($node));

    $operations[] = array('_mica_studies_export_dto_dataset_dto', array($node));

    //  $operations[] = array('_mica_studies_export_dto_network_dto', array($node));
    $operations[] = array('_mica_studies_export_dto_save_json_file', array());
    //Send Dto via REST

    //Send File

  }

  // prepare batch steps
  batch_set(array(
    'operations' => $operations,
    'finished' => 'mica_studies_dto_batch_finished',
  ));
  $redirect = 'node/' . $node->nid;
  batch_process($redirect);
}

/**
 * Create tmp folder
 */
function _mica_studies_export_dto_create_tmp_folder($folder_name) {
  $tmp_folder_name = file_directory_temp() . '/export-dto' . $folder_name . '-' . date('Y-m-d_H_m_s', time());
  drupal_mkdir($tmp_folder_name);
  return $tmp_folder_name;
}

function _mica_studies_export_dto_save_json_file(&$context) {
  global $user;

  $tmp_folder_root = _mica_studies_export_dto_create_tmp_folder(str_replace(' ', '_', $context['results']['study']['title_study']));

  //save study json
  $tmp_file_study_name = str_replace(' ', '_', $context['results']['study']['title_study'] . '-' . date('Y-m-d_H_m_s', time()));
  file_unmanaged_save_data($context['results']['study']['study_json'], $tmp_folder_root . '/' . $tmp_file_study_name . '.json', FILE_EXISTS_RENAME);

  foreach ($context['results']['datasets'] as $dataset) {
    $tmp_file_root_dataset_name = $tmp_folder_root . '/' . str_replace(' ', '_', $dataset['title_dataset'] . '-' . date('Y-m-d_H_m_s', time()));
    file_unmanaged_save_data($dataset['dataset_json'], $tmp_file_root_dataset_name . '.json', FILE_EXISTS_RENAME);
  }

  $zip_file_to_download = mica_studies_export_dto_create_zip_file($tmp_folder_root, $tmp_file_study_name);
  //delete temp files
  file_unmanaged_delete_recursive($tmp_folder_root);

  drupal_set_message(
    t("<a href='@file_url'>Download exported study zip file.</a> This file is also available in your <a href='@file_manager_url'>File manager</a>",
      array(
        '@file_url' => file_create_url($zip_file_to_download),
        '@file_manager_url' => url('user/' . $user->uid . '/imce')
      )),
    'status');
}

function mica_studies_export_dto_create_zip_file($folder_to_zip, $name_zipe_file) {
  global $user;
  //retrieve files in directory to archive
  $scanned_directory = array_diff(scandir($folder_to_zip), array('..', '.'));
  //Archive the files
  $zip_file_path = drupal_realpath('public:///' . $user->name . '/export-mica-server/' . $name_zipe_file . '.zip');
  fopen($zip_file_path, 'w');
  $zip = new ZipArchive;
  $zip->open($zip_file_path);
  foreach ($scanned_directory as $file) {
    $zip->addFile($folder_to_zip . '/' . $file, $folder_to_zip . '/' . $file);
  }
  fclose($zip_file_path);
  return 'public:///' . $user->name . '/export-mica-server/' . $name_zipe_file . '.zip';
}

function mica_studies_dto_batch_finished() {

}
